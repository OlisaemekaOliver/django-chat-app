<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatFlo - Conversation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    {% comment %} <link rel="stylesheet" href="style.css"> {% endcomment %}
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 h-screen flex flex-col">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-indigo-600">Conversation {{ conversation.id }}</h2>
            <a href="{% url 'logout' %}" class="flex items-center text-red-500 hover:text-red-700 transition-colors">
                <i data-feather="log-out" class="mr-2"></i>
                Logout
            </a>
        </header>

        <!-- Messages Container -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 bg-white rounded-lg shadow-md mb-4 space-y-4">
            {% for msg in messages %}
            <div class="{% if msg.sender.username == request.user.username %}text-right{% endif %}">
                <div class="inline-block max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-lg 
                    {% if msg.sender.username == request.user.username %}bg-indigo-100 text-indigo-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                    <p class="font-semibold">{{ msg.sender.username }}</p>
                    <p>{{ msg.text }}</p>
                    <p class="text-xs text-gray-500 mt-1">{{ msg.timestamp|time }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Typing Indicator -->
        <p id="typingIndicator" class="text-sm text-gray-400 italic h-4 mb-1"></p>

        <!-- Message Input -->
        <div class="flex gap-2">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your message..." 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            >
            <button 
                onclick="sendMessage()"
                class="px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors flex items-center"
            >
                <i data-feather="send" class="mr-2"></i>
                Send
            </button>
        </div>
    </div>

    <!-- WebSocket Script -->
    <script>
    const conversationId = "{{ conversation.id }}";
    const username = "{{ request.user.username }}";
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${conversationId}/`);


    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const msgBox = document.getElementById("messages");

        if(data.message) {
            const messageHtml = `
                <div class="text-right">
                    <div class="inline-block max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-lg 
                        ${data.sender === username ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'}">
                        <p class="font-semibold">${data.sender}</p>
                        <p>${data.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    </div>
                </div>
            `;
            msgBox.innerHTML += messageHtml;
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        if(data.typing && data.sender !== username) {
            document.getElementById("typingIndicator").innerText = `${data.sender} is typing...`;
            setTimeout(() => {
                document.getElementById("typingIndicator").innerText = "";
            }, 2000);
        }
    };

    function sendMessage() {
        const input = document.getElementById("messageInput");
        if (input.value.trim() !== "") {
            ws.send(JSON.stringify({ message: input.value, sender: username }));
            input.value = "";
        }
    }

    document.getElementById("messageInput").addEventListener("input", () => {
        ws.send(JSON.stringify({ typing: true, sender: username }));
    });

    // Auto-focus input on load
    document.getElementById("messageInput").focus();

    // Send message on Enter key
    document.getElementById("messageInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });
    </script>
    <script>feather.replace();</script>
</body>
</html>


















